<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../partials/header1.ejs') %>
    <link rel="stylesheet" href="/public/css/admin.css" />
</head>
<body>
    <header>
        <%- include('../partials/navbar-admin.ejs') %>
    </header>
    
    <div class="admin-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <h2>Admin Menu</h2>
            <a href="/admin/view-users" class="menu-item active">User Management</a>
            <a href="/admin/view-menu" class="menu-item">Menu Items</a>
            <a href="/admin/view-tables" class="menu-item">Table Management</a>
            <a href="/admin/view-dietary" class="menu-item">Dietary Preferences</a>
            <a href="/admin/view-faqs" class="menu-item">FAQs</a>
            <a href="/admin/admin-report" class="menu-item">Reports</a>
        </nav>

        <!-- Main content -->
        <section class="main-content">
            <h1>User Management</h1>
            <p class="welcome">Welcome <span><%= adminEmail %></span>!</p>

            <!-- Toolbar -->
            <div class="toolbar">
                <input id="userSearch" class="search-input" type="search"
                       placeholder="Search by username, email, or role…">
                <!-- Slot for future bulk‑action buttons or CSV export, etc. -->
            </div>

            <!-- Users table -->
            <table class="users-table" id="usersTable">
                <thead>
                    <tr>
                        <th data-col="userId">ID &#x25B2;</th>
                        <th data-col="username">Name</th>
                        <th data-col="email">Email</th>
                        <th data-col="role">Role</th>
                        <th style="width: 250px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% users.forEach(user => { %>
                      <tr>
                          <td><%= user.userId %></td>
                          <td><%= user.username %></td>
                          <td><%= user.email %></td>
                          <td><%= user.role %></td>
                          <td>
                              <% if (user.role !== 'admin') { %>
                                  <form action="/admin/users/<%= user.userId %>/promote" method="POST" style="display:inline;">
                                      <button class="btn btn-promote">Promote</button>
                                  </form>
                              <% } else { %>
                                  <form action="/admin/users/<%= user.userId %>/demote" method="POST" style="display:inline;">
                                      <button class="btn btn-demote">Demote</button>
                                  </form>
                              <% } %>

                              <form action="/admin/users/<%= user.userId %>?_method=DELETE"
                                    method="POST"
                                    style="display:inline;"
                                    onsubmit="return confirm('Delete <%= user.username %>?');">
                                  <button class="btn btn-delete">Delete</button>
                              </form>
                          </td>
                      </tr>
                  <% }) %>
                </tbody>
            </table>
        </section>
    </div>

    <!-- Client‑side search + simple column sorting -->
    <script>
        (function () {
            const rows   = [...document.querySelectorAll('#usersTable tbody tr')];
            const search = document.getElementById('userSearch');

            /* ---- live search ---- */
            search.addEventListener('input', e => {
                const q = e.target.value.toLowerCase();
                rows.forEach(row => {
                    row.style.display = row.innerText.toLowerCase().includes(q) ? '' : 'none';
                });
            });

            /* ---- basic sort ---- */
            let asc = true;
            document.querySelectorAll('#usersTable thead th[data-col]').forEach(th => {
                th.addEventListener('click', () => {
                    const col = th.dataset.col;
                    asc = !asc;
                    document.querySelectorAll('#usersTable thead th[data-col]').forEach(h => {
                        h.innerHTML = h.innerHTML.replace(' ▲', '').replace(' ▼', '');
                    });
                    th.innerHTML = th.textContent + (asc ? ' ▲' : ' ▼');

                    rows.sort((a, b) => {
                        const ta = a.querySelector('td:nth-child(' + (th.cellIndex + 1) + ')').innerText;
                        const tb = b.querySelector('td:nth-child(' + (th.cellIndex + 1) + ')').innerText;
                        return asc ? ta.localeCompare(tb, undefined, {numeric: true}) :
                                     tb.localeCompare(ta, undefined, {numeric: true});
                    });
                    const tbody = th.closest('table').querySelector('tbody');
                    rows.forEach(r => tbody.appendChild(r));
                });
            });
        })();
    </script>
</body>
</html>